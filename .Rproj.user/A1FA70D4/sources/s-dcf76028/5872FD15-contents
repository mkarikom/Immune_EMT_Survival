library(textreg)
library(tibble)
library(dplyr)
library(htmltab)

library(gridExtra)
library(mclust)
library(Cairo)
library(dplyr)

source("./Cox_model_functions.R")
source("./Cox_support_functions.R")

# ./DataRDS
# ./UMAP_1D
# ./UMAP_DBSCAN_Clust
# ./UMAP_gpml_data
# ./UMAP_Plots
# ./UMAP_Plots_ClassDFI
# ./UMAP_Plots_GP
# ./UMAP_Signif_GeneSets
# ./UMAP_Tables
# ./UMAP_Tables_GP
# ./UMAP_Tables_GPML_Vars

setwd("./OS_Pipeline/R")

# get the GDC data by running:
# relevant directories: DataRDS
dir.create("./DataRDS/raw_data")
source("./saveTumorRDS.R")

# get only the primary tumor from those patients
# relevant directories: DataRDS
datadir = ""
dir.create("./DataRDS/primary_tumors/")
source("./save_primary_data.R")

# get all the geneset combos
# relevant directories: DataRDS
dir.create("./DataRDS/gene_sets/")
source("./saveSets.R")

# get 1D UMAP embeddings of all the patients
# relevant directories: UMAP_DataRDS, UMAP_1D
source("./UMAP_1D_embed.R")

# find the p-values, and run survival.  Save the genesets in UMAP_Signif_Genesets/bothHR_all.csv (HR is high for Both)
# relevant directories:
# UMAP_1D: the 1D embeddings of the patients for each cluster
# UMAP_Signif_GeneSets (the gene sets that satisfy criteria for Both vs EMT and INFLAM: [onlyBoth] = EMT/INFLAM not sig & Both sig; [bothHR] = all 3 are sig but both HR is higher than other two),
# UMAP_Surv_Plots_onlyBoth (plots of the KM and clustering for Cox models that satisfy the criteria),
# UMAP_Surv_Tables_onlyBoth (tables of Cox and KM models for import to the manuscript)
# UMAP_Surv_Plots_bothHR (plots of the KM and clustering for Cox models that satisfy the criteria),
# UMAP_Surv_Tables_bothHR (tables of Cox and KM models for import to the manuscript)
source("./UMAP_1D_Surv.R")

# find
#   1) the DFI class of each patient
#   2) the highly expressed genes from the prolif list (GO_MESENCHYMAL_CELL_PROLIFERATION)
#   3) an optional 2D UMAP embedding of expression of these genes for each patient
#   4) a table of each bothHR group (a specific cluster/tumortype/combo) where only the top bothHR group from each tumor type is included)
# relevant directories:
# UMAP_DataRDS: the main output is Prolif_acc.txt, which has each DBSCAN cluster for tumor/combo where the bothHR criteria holds, filtered so that only combo with the highest HR for Both is retained
# UMAP_Tables_GP: stores the UMAP embedding and 45-gene expression for the gene set in separate tables so each can be accessed via matlab to do the training
# UMAP_Tables_GP_Genelists: stores the genes for each row of Prolif_acc.txt which are expressed in at least 10% of the patients in that group (and the accompanying datatype for matlab readtable)
source("./surv_DFI_Bayes_Single.R")

# find the GP model and top ARD genes for GO_MESENCHYMAL_CELL_PROLIFERATION
# relevant directories:
# UMAP_Plots_GP: stores the posterior level curve plots for the top ARD genes after running the script below
# UMAP_Tables_GPML_Vars: stores the saved variables for each cluster in the

# run gp_tumor_single.m, which reads UMAP_DataRDS/Prolif_acc.txt and creates a model for each row
